<!doctype html>
<html lang="vi">
<head>
  <!-- =========================================================
       CRM Bootstrap Full – Fixed Authentication Flow
       Improvements:
       - Proper auth flow with auth.uid() instead of email
       - RLS enabled with proper policies
       - Auto-provisioning with triggers
       - Whitelist support
       - Better permission system
       ========================================================= -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CRM • Supabase • Bootstrap Admin</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root {
      --sidebar-width: 280px;
      --primary-color: #0d6efd;
      --hover-bg: #e7f1ff;
      --border-color: #e9ecef;
      --shadow: 0 8px 24px rgba(0,0,0,.06);
    }

    * { box-sizing: border-box; }
    
    html, body { 
      height: 100%; 
      background-color: #f8f9fa; 
      font-size: 14px;
    }
    
    /* Sidebar Styles */
    .sidebar { 
      width: var(--sidebar-width); 
      min-height: 100vh; 
      position: fixed; 
      top: 0; 
      left: 0; 
      border-right: 1px solid var(--border-color); 
      background: #fff; 
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1040;
    }
    
    .sidebar.show { transform: translateX(0); }
    
    .sidebar .nav-link { 
      border-radius: .5rem; 
      color: #334155; 
      transition: all 0.2s ease;
    }
    
    .sidebar .nav-link.active, 
    .sidebar .nav-link:hover { 
      background-color: var(--hover-bg); 
      color: var(--primary-color); 
    }
    
    /* Content Wrapper */
    .content-wrap { 
      margin-left: 0; 
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }
    
    /* Desktop Styles */
    @media (min-width: 992px) { 
      .sidebar { transform: translateX(0); }
      .content-wrap { margin-left: var(--sidebar-width); }
      .mobile-header { display: none; }
    }
    
    /* Mobile Header */
    .mobile-header {
      position: sticky;
      top: 0;
      z-index: 1030;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
    }
    
    /* Card Styles */
    .card-shadow { 
      box-shadow: var(--shadow); 
      border: 1px solid #eef2f7; 
      border-radius: 1rem;
      transition: transform 0.2s ease;
    }
    
    .card-shadow:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,.08);
    }

    /* Autocomplete Styles */
    .suggestions { 
      position: absolute; 
      z-index: 1050; 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: .5rem; 
      max-height: 260px; 
      overflow-y: auto; 
      width: 100%; 
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      margin-top: 2px;
    }
    
    .suggestion-item { 
      padding: .75rem 1rem; 
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .suggestion-item:hover,
    .suggestion-item.active { 
      background: #f5f7fb; 
    }

    /* Form Improvements */
    .form-control, .form-select {
      font-size: 14px;
      padding: 0.5rem 0.75rem;
    }
    
    .form-label {
      font-weight: 500;
      color: #475569;
      margin-bottom: 0.25rem;
    }

    /* Table Responsive */
    .table-responsive {
      border-radius: 0.5rem;
      overflow: hidden;
    }
    
    .table {
      font-size: 13px;
      margin-bottom: 0;
    }
    
    .table th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
      padding: 0.75rem;
    }
    
    /* Mobile Table */
    @media (max-width: 768px) {
      .table-responsive {
        font-size: 12px;
      }
      
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 12px;
      }
      
      .table td {
        padding: 0.5rem;
      }
    }

    /* Loading State */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Overlay */
    .overlay {
      position: fixed; 
      inset: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: rgba(15,23,42,.55); 
      backdrop-filter: blur(2px); 
      z-index: 3000;
    }
    
    .overlay-card {
      width: min(420px, 90vw); 
      border-radius: 1rem; 
      box-shadow: 0 20px 40px rgba(0,0,0,.2);
    }
    
    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Section Spacing */
    .section-anchor { 
      scroll-margin-top: 80px; 
    }
    
    /* Button Groups */
    .btn-group-sm > .btn {
      padding: 0.25rem 0.5rem;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1080;
    }
    
    /* Backdrop for mobile */
    .sidebar-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1039;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.5);
      display: none;
    }
    
    .sidebar-backdrop.show {
      display: block;
    }
    
    /* Pending approval state */
    .pending-approval {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }
  </style>
</head>
<body>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Mobile Header -->
  <div class="mobile-header d-lg-none">
    <div class="d-flex align-items-center justify-content-between">
      <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle">
        <i class="bi bi-list fs-5"></i>
      </button>
      <span class="fw-bold">CRM Admin</span>
      <img src="https://ui-avatars.com/api/?name=CRM&background=0D6EFD&color=fff" alt="" width="32" height="32" class="rounded-circle">
    </div>
  </div>

  <!-- Sidebar Backdrop -->
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <!-- ===== AUTH OVERLAY ===== -->
  <div id="authOverlay" class="overlay d-none">
    <div class="card overlay-card fade-in">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập VSEC CRM</h5>
        <p class="text-muted small mb-4">Vui lòng đăng nhập với tài khoản Google của bạn</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2">
          <i class="bi bi-google me-2"></i>Đăng nhập với Google
        </button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- ===== PENDING APPROVAL OVERLAY ===== -->
  <div id="pendingOverlay" class="overlay d-none">
    <div class="card overlay-card fade-in pending-approval">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-clock-history" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Tài khoản đang chờ phê duyệt</h5>
        <p class="text-muted small mb-3">
          Email <strong id="pendingEmail"></strong> đã được ghi nhận.<br>
          Vui lòng liên hệ Admin để được kích hoạt tài khoản.
        </p>
        <button id="btnCheckAgain" class="btn btn-warning btn-sm me-2">
          <i class="bi bi-arrow-clockwise me-1"></i>Kiểm tra lại
        </button>
        <button id="btnSignOutPending" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-box-arrow-right me-1"></i>Đăng xuất
        </button>
      </div>
    </div>
  </div>

  <!-- ========================= SIDEBAR ========================= -->
  <aside class="sidebar p-3" id="sidebar">
    <a class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
      <span class="fs-5 fw-bold"><i class="bi bi-layout-text-sidebar-reverse me-2"></i>CRM Admin</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column gap-1" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-page="customers"><i class="bi bi-people me-2"></i>Customers</a></li>
      <li class="nav-item" id="navServices" style="display:none"><a class="nav-link" data-page="services"><i class="bi bi-box-seam me-2"></i>Services</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="opportunities"><i class="bi bi-bullseye me-2"></i>Opportunities</a></li>
      <li class="nav-item"><a class="nav-link" data-page="quotes"><i class="bi bi-receipt me-2"></i>Quotes</a></li>
      <li class="nav-item"><a class="nav-link" data-page="contracts"><i class="bi bi-file-earmark-text me-2"></i>Contracts</a></li>
      <li class="nav-item"><a class="nav-link" data-page="users" id="navUsers"><i class="bi bi-person-gear me-2"></i>Users</a></li>
    </ul>
    <hr>
    <div class="dropdown">
      <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img src="https://ui-avatars.com/api/?name=CRM&background=0D6EFD&color=fff" alt="" width="32" height="32" class="rounded-circle me-2">
        <strong id="currentEmail">guest@local</strong>
      </a>
      <ul class="dropdown-menu shadow">
        <li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
      </ul>
    </div>
  </aside>

  <!-- ========================= MAIN ========================= -->
  <main class="content-wrap">
    <div class="container-fluid py-3 py-lg-4">

      <!-- DASHBOARD -->
      <section id="page-dashboard" class="section-anchor">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
        </div>
        <div class="row g-3">
          <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Customers</h6><h2 class="fw-bold mb-0" id="kpiCustomers">0</h2></div></div></div>
          <div class="col-6 col-lg-3" id="kpiServicesWrap" style="display:none"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Services</h6><h2 class="fw-bold mb-0" id="kpiServices">0</h2></div></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Projects</h6><h2 class="fw-bold mb-0" id="kpiProjects">0</h2></div></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1 small">Opportunities</h6><h2 class="fw-bold mb-0" id="kpiOpportunities">0</h2></div></div></div>
        </div>
        <div class="card card-shadow mt-3"><div class="card-body"><div class="text-secondary">Tổng giá trị cơ hội: <span class="fw-bold" id="kpiOppValue">0</span></div></div></div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-people me-2"></i>Customers</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddCustomer"><i class="bi bi-plus-lg me-1"></i>Thêm KH</button></div>
        </div>
        <div id="customerFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Name</th><th class="d-none d-md-table-cell">Contact</th><th class="d-none d-lg-table-cell">Phone</th><th class="d-none d-lg-table-cell">Email</th><th class="d-none d-xl-table-cell">Tax</th><th style="width:100px;">Actions</th></tr></thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- SERVICES (DISABLED) -->
      <section id="page-services" class="section-anchor d-none"></section>

      <!-- PROJECTS -->
      <section id="page-projects" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-kanban me-2"></i>Projects</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddProject"><i class="bi bi-plus-lg me-1"></i>Thêm dự án</button></div>
        </div>
        <div id="projectFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Tên dự án</th><th class="d-none d-md-table-cell">Khách hàng</th><th class="d-none d-lg-table-cell">Start</th><th class="d-none d-lg-table-cell">End</th><th>Status</th><th style="width:100px;">Actions</th></tr></thead>
            <tbody id="projectTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- OPPORTUNITIES -->
      <section id="page-opportunities" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-bullseye me-2"></i>Opportunities</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddOpportunity"><i class="bi bi-plus-lg me-1"></i>Thêm cơ hội</button></div>
        </div>
        <div id="oppFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Tên cơ hội</th><th class="d-none d-md-table-cell">Khách hàng</th><th>Giá trị</th><th>Stage</th><th style="width:100px;">Actions</th></tr></thead>
            <tbody id="oppTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- QUOTES -->
      <section id="page-quotes" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-receipt me-2"></i>Quotes</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddQuote"><i class="bi bi-plus-lg me-1"></i>Thêm báo giá</button></div>
        </div>
        <div id="quoteFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th class="d-none d-md-table-cell">Khách hàng</th>
                <th class="d-none d-lg-table-cell">Dự án</th>
                <th class="text-start">Nội dung</th>
                <th>Số tiền</th>
                <th class="d-none d-md-table-cell">Status</th>
                <th class="d-none d-lg-table-cell">Lần gửi</th>
                <th class="d-none d-xl-table-cell">PDF</th>
                <th style="width:100px;">Actions</th>
              </tr>
            </thead>
            <tbody id="quoteTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- CONTRACTS -->
      <section id="page-contracts" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-file-earmark-text me-2"></i>Contracts</h1>
          <div class="ms-auto"><button class="btn btn-primary btn-sm" id="btnAddContract"><i class="bi bi-plus-lg me-1"></i>Thêm HĐ</button></div>
        </div>
        <div id="contractFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>ID</th><th>Dự án</th><th class="d-none d-md-table-cell">Khách hàng</th><th>Giá trị</th><th>Status</th><th style="width:100px;">Actions</th></tr></thead>
            <tbody id="contractTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- USERS -->
      <section id="page-users" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-person-gear me-2"></i>Users</h1>
          <div class="ms-auto">
            <button class="btn btn-success btn-sm me-2" id="btnPendingUsers">
              <i class="bi bi-person-clock me-1"></i>Pending (<span id="pendingCount">0</span>)
            </button>
            <button class="btn btn-primary btn-sm" id="btnAddUser">
              <i class="bi bi-plus-lg me-1"></i>Thêm user
            </button>
          </div>
        </div>
        
        <!-- Pending Users Section -->
        <div id="pendingUsersWrap" class="d-none mb-3">
          <div class="card card-shadow pending-approval">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="bi bi-clock-history me-2"></i>Users đang chờ phê duyệt
              </h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead><tr><th>Email</th><th>Ngày đăng ký</th><th>Actions</th></tr></thead>
                  <tbody id="pendingUsersTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div id="userFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th>Email</th><th>Role</th><th>Active</th><th style="width:100px;">Actions</th></tr></thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div></div>
      </section>

    </div>
  </main>

  <!-- ========================= SCRIPTS ========================= -->
  <script>
    /* ===== CONFIGURATION ===== */
    const CONFIG = {
      SUPABASE_URL: 'https://subhfwepmvxdowahfiun.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1Ymhmd2VwbXZ4ZG93YWhmaXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NzEyNjcsImV4cCI6MjA3MDE0NzI2N30.bRAZ35yzf6Ybz2W6qr5Fut4AGhM0tZQO-vQWztwxI8Q',
      DEBOUNCE_DELAY: 300,
      TOAST_DURATION: 3000
    };

    /* ===== SUPABASE CLIENT ===== */
    const sb = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    /* ===== APPLICATION STATE ===== */
    const state = {
      currentUser: { 
        id: null,           // auth.uid() - QUAN TRỌNG!
        email: null, 
        role: 'user',
        active: false
      },
      customers: [],
      services: [],
      projects: [],
      opportunities: [],
      quotes: [],
      contracts: [],
      users: [],
      pendingUsers: [],
      cache: {
        customerMap: new Map(),
        projectMap: new Map()
      }
    };

    /* ===== UTILITY FUNCTIONS ===== */
    const utils = {
      pad: (n, w) => String(n).padStart(w, '0'),
      
      getWeekNumber(date = new Date()) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      },
      
      money: (n) => (n || 0).toLocaleString('vi-VN'),
      
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },
      
      showToast(message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container');
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0 fade show`;
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        `;
        toastContainer.appendChild(toastEl);
        setTimeout(() => toastEl.remove(), CONFIG.TOAST_DURATION);
      },
      
      showLoading(element) {
        const originalContent = element.innerHTML;
        element.innerHTML = '<div class="loading mx-auto"></div>';
        element.disabled = true;
        return () => {
          element.innerHTML = originalContent;
          element.disabled = false;
        };
      }
    };

    /* ===== ID GENERATORS ===== */
    const generators = {
      customerId() {
        const used = state.customers.map(c => parseInt(c.id?.slice(1), 10)).filter(Number.isFinite);
        for (let i = 1; i < 10000; i++) {
          if (!used.includes(i)) return 'C' + utils.pad(i, 4);
        }
        throw new Error('Hết mã khách hàng');
      },
      
      projectId() {
        const y = new Date().getFullYear().toString().slice(-2);
        const used = state.projects
          .filter(p => p.project_id?.startsWith('P_' + y))
          .map(p => parseInt(p.project_id.slice(4), 10))
          .filter(Number.isFinite);
        for (let i = 1; i < 1000; i++) {
          if (!used.includes(i)) return 'P_' + y + utils.pad(i, 3);
        }
        throw new Error('Hết mã dự án');
      },
      
      opportunityId() {
        const used = state.opportunities
          .map(o => parseInt(o.opportunity_id?.split('_')[1], 10))
          .filter(Number.isFinite);
        for (let i = 1; i < 100000; i++) {
          if (!used.includes(i)) return 'Op_' + utils.pad(i, 5);
        }
        throw new Error('Hết mã cơ hội');
      },
      
      quoteId() {
        const now = new Date();
        const y = now.getFullYear().toString().slice(-2);
        const w = utils.pad(utils.getWeekNumber(now), 2);
        const prefix = `Q_${y}${w}`;
        const used = state.quotes
          .filter(q => q.quotes_id?.startsWith(prefix))
          .map(q => parseInt(q.quotes_id.slice(6), 10))
          .filter(Number.isFinite);
        for (let i = 1; i <= 99; i++) {
          if (!used.includes(i)) return prefix + utils.pad(i, 2);
        }
        throw new Error('Hết mã báo giá');
      },
      
      contractId() {
        const now = new Date();
        const y = now.getFullYear().toString().slice(-2);
        const w = utils.pad(utils.getWeekNumber(now), 2);
        const prefix = `HD_${y}${w}`;
        const used = state.contracts
          .filter(c => c.contract_id?.startsWith(prefix))
          .map(c => parseInt(c.contract_id.slice(7), 10))
          .filter(Number.isFinite);
        for (let i = 1; i <= 99; i++) {
          if (!used.includes(i)) return prefix + utils.pad(i, 2);
        }
        throw new Error('Hết mã hợp đồng');
      }
    };

    /* ===== LOCAL STORAGE HELPERS ===== */
    const storage = {
      getMyCustomerIds() {
        try {
          const map = JSON.parse(localStorage.getItem('myCustomers') || '{}');
          return map[state.currentUser.email] || [];
        } catch {
          return [];
        }
      },
      
      pushMyCustomerId(id) {
        try {
          const map = JSON.parse(localStorage.getItem('myCustomers') || '{}');
          map[state.currentUser.email] = map[state.currentUser.email] || [];
          if (!map[state.currentUser.email].includes(id)) {
            map[state.currentUser.email].push(id);
          }
          localStorage.setItem('myCustomers', JSON.stringify(map));
        } catch {}
      },
      
      // Track who created what - now using user.id instead of email
      getCreatedBy(table) {
        try {
          const data = JSON.parse(localStorage.getItem(`createdBy_${table}`) || '{}');
          return data;
        } catch {
          return {};
        }
      },
      
      setCreatedBy(table, id, userId) {
        try {
          const data = this.getCreatedBy(table);
          data[id] = userId;  // Store user.id instead of email
          localStorage.setItem(`createdBy_${table}`, JSON.stringify(data));
        } catch {}
      },
      
      canEdit(table, id) {
        const isElevated = ['admin', 'BOM'].includes(state.currentUser.role);
        if (isElevated) return true;
        
        const createdBy = this.getCreatedBy(table);
        return createdBy[id] === state.currentUser.id;  // Compare with user.id
      }
    };

    /* ===== UI HELPERS ===== */
    const ui = {
      showSection(page) {
        document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('d-none'));
        const section = document.getElementById(`page-${page}`);
        if (section) {
          section.classList.remove('d-none');
          section.classList.add('fade-in');
        }
        
        document.querySelectorAll('.sidebar .nav-link').forEach(a => {
          if (a.dataset.page === page) {
            a.classList.add('active');
          } else {
            a.classList.remove('active');
          }
        });
        
        // Close mobile sidebar
        if (window.innerWidth < 992) {
          ui.toggleSidebar(false);
        }
      },
      
      toggleSidebar(show) {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        
        if (show === undefined) {
          show = !sidebar.classList.contains('show');
        }
        
        if (show) {
          sidebar.classList.add('show');
          backdrop.classList.add('show');
        } else {
          sidebar.classList.remove('show');
          backdrop.classList.remove('show');
        }
      },
      
      setKPIs() {
        document.getElementById('kpiCustomers').textContent = state.customers.length;
        document.getElementById('kpiProjects').textContent = state.projects.length;
        document.getElementById('kpiOpportunities').textContent = state.opportunities.length;
        const totalValue = state.opportunities.reduce((sum, o) => sum + (o.expected_value || 0), 0);
        document.getElementById('kpiOppValue').textContent = utils.money(totalValue) + ' đ';
      }
    };

    /* ===== DATA LOADING ===== */
    async function loadData() {
      try {
        const [customersRes, projectsRes, opportunitiesRes, quotesRes, contractsRes, usersRes] = await Promise.all([
          sb.from('customers').select('*').order('id'),
          sb.from('projects').select('*').order('project_id'),
          sb.from('opportunities').select('*').order('opportunity_id'),
          sb.from('quotes').select('*').order('quotes_id'),
          sb.from('contracts').select('*').order('contract_id'),
          sb.from('user_profiles').select('*')
        ]);

        state.customers = customersRes.data || [];
        state.projects = projectsRes.data || [];
        state.opportunities = opportunitiesRes.data || [];
        state.quotes = quotesRes.data || [];
        state.contracts = contractsRes.data || [];
        
        // Phân loại users: active và pending
        const allUsers = usersRes.data || [];
        state.users = allUsers.filter(u => u.active);
        state.pendingUsers = allUsers.filter(u => !u.active);

        // Update cache
        state.cache.customerMap.clear();
        state.customers.forEach(c => state.cache.customerMap.set(c.id, c));
        
        state.cache.projectMap.clear();
        state.projects.forEach(p => state.cache.projectMap.set(p.project_id, p));
        
      } catch (error) {
        console.error('Error loading data:', error);
        utils.showToast('Lỗi khi tải dữ liệu', 'error');
      }
    }

    /* ===== CRUD OPERATIONS ===== */
    const crud = {
      async create(table, data) {
        try {
          const { error } = await sb.from(table).insert([data]);
          if (error) throw error;
          await loadData();
          utils.showToast('Thêm mới thành công');
          return true;
        } catch (error) {
          utils.showToast(error.message, 'error');
          return false;
        }
      },
      
      async update(table, data, matchColumn, matchValue) {
        try {
          const { error } = await sb.from(table).update(data).eq(matchColumn, matchValue);
          if (error) throw error;
          await loadData();
          utils.showToast('Cập nhật thành công');
          return true;
        } catch (error) {
          utils.showToast(error.message, 'error');
          return false;
        }
      },
      
      async delete(table, matchColumn, matchValue) {
        try {
          const { error } = await sb.from(table).delete().eq(matchColumn, matchValue);
          if (error) throw error;
          await loadData();
          utils.showToast('Xóa thành công');
          return true;
        } catch (error) {
          utils.showToast(error.message, 'error');
          return false;
        }
      }
    };

    /* ===== RENDER FUNCTIONS ===== */
    const renderers = {
      dashboard() {
        ui.setKPIs();
      },
      
      customers() {
        const tbody = document.getElementById('customerTbody');
        let list = state.customers;
        
        const isElevated = ['admin', 'BOM'].includes(state.currentUser.role);
        if (!isElevated) {
          const allowedIds = storage.getMyCustomerIds();
          list = state.customers.filter(c => allowedIds.includes(c.id));
        }
        
        tbody.innerHTML = list.map(c => {
          const canEdit = storage.canEdit('customers', c.id);
          return `
            <tr>
              <td>${c.id}</td>
              <td class="text-start fw-medium">${c.name || ''}</td>
              <td class="d-none d-md-table-cell">${c.contact_person || ''}</td>
              <td class="d-none d-lg-table-cell">${c.phone || ''}</td>
              <td class="d-none d-lg-table-cell">${c.email || ''}</td>
              <td class="d-none d-xl-table-cell">${c.tax_code || ''}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  ${canEdit ? `
                    <button class="btn btn-outline-secondary" onclick="crmForms.customer('${c.id}')">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="handlers.deleteCustomer('${c.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : '<span class="text-muted small">Chỉ xem</span>'}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      projects() {
        const tbody = document.getElementById('projectTbody');
        tbody.innerHTML = state.projects.map(p => {
          const customer = state.cache.customerMap.get(p.customer_id);
          const canEdit = storage.canEdit('projects', p.project_id);
          return `
            <tr>
              <td>${p.project_id}</td>
              <td class="text-start fw-medium">${p.project_name || ''}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : p.customer_id}</td>
              <td class="d-none d-lg-table-cell">${p.start_date || ''}</td>
              <td class="d-none d-lg-table-cell">${p.end_date || ''}</td>
              <td><span class="badge bg-secondary">${p.status || ''}</span></td>
              <td>
                <div class="btn-group btn-group-sm">
                  ${canEdit ? `
                    <button class="btn btn-outline-secondary" onclick="crmForms.project('${p.project_id}')">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="handlers.deleteProject('${p.project_id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : '<span class="text-muted small">Chỉ xem</span>'}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      opportunities() {
        const tbody = document.getElementById('oppTbody');
        tbody.innerHTML = state.opportunities.map(o => {
          const customer = state.cache.customerMap.get(o.customer_id);
          const canEdit = storage.canEdit('opportunities', o.opportunity_id);
          return `
            <tr>
              <td>${o.opportunity_id}</td>
              <td class="text-start fw-medium">${o.name || ''}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : o.customer_id}</td>
              <td>${utils.money(o.expected_value)}</td>
              <td><span class="badge bg-info">${o.stage || ''}</span></td>
              <td>
                <div class="btn-group btn-group-sm">
                  ${canEdit ? `
                    <button class="btn btn-outline-secondary" onclick="crmForms.opportunity('${o.opportunity_id}')">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="handlers.deleteOpportunity('${o.opportunity_id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : '<span class="text-muted small">Chỉ xem</span>'}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      quotes() {
        const tbody = document.getElementById('quoteTbody');
        tbody.innerHTML = state.quotes.map(q => {
          const customer = state.cache.customerMap.get(q.customer_id);
          const project = state.cache.projectMap.get(q.project_id);
          const canEdit = storage.canEdit('quotes', q.quotes_id);
          return `
            <tr>
              <td>${q.quotes_id}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : q.customer_id}</td>
              <td class="d-none d-lg-table-cell">${project ? project.project_name : (q.project_id || '')}</td>
              <td class="text-start">${q.description || ''}</td>
              <td>${utils.money(q.amount)}</td>
              <td class="d-none d-md-table-cell"><span class="badge bg-secondary">${q.status || ''}</span></td>
              <td class="d-none d-lg-table-cell">${q.send_count || 0}</td>
              <td class="d-none d-xl-table-cell">${q.pdf_url ? `<a href="${q.pdf_url}" target="_blank">PDF</a>` : ''}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  ${canEdit ? `
                    <button class="btn btn-outline-secondary" onclick="crmForms.quote('${q.quotes_id}')">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="handlers.deleteQuote('${q.quotes_id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : '<span class="text-muted small">Chỉ xem</span>'}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      contracts() {
        const tbody = document.getElementById('contractTbody');
        tbody.innerHTML = state.contracts.map(ct => {
          const project = state.cache.projectMap.get(ct.project_id);
          const customer = state.cache.customerMap.get(ct.customer_id);
          const canEdit = storage.canEdit('contracts', ct.contract_id);
          return `
            <tr>
              <td>${ct.contract_id}</td>
              <td class="text-start fw-medium">${project ? project.project_name : ct.project_id}</td>
              <td class="d-none d-md-table-cell">${customer ? customer.name : ct.customer_id}</td>
              <td>${utils.money(ct.value)}</td>
              <td><span class="badge bg-success">${ct.status || ''}</span></td>
              <td>
                <div class="btn-group btn-group-sm">
                  ${canEdit ? `
                    <button class="btn btn-outline-secondary" onclick="crmForms.contract('${ct.contract_id}')">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="handlers.deleteContract('${ct.contract_id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : '<span class="text-muted small">Chỉ xem</span>'}
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      users() {
        // Only admin and BOM can see Users tab
        const canSeeUsers = ['admin', 'BOM'].includes(state.currentUser.role);
        document.getElementById('navUsers').style.display = canSeeUsers ? '' : 'none';
        
        if (!canSeeUsers) return;
        
        // Update pending count
        document.getElementById('pendingCount').textContent = state.pendingUsers.length;
        
        // Render active users
        const tbody = document.getElementById('userTbody');
        tbody.innerHTML = state.users.map(u => `
          <tr>
            <td class="text-start">${u.email}</td>
            <td><span class="badge bg-primary">${u.role || ''}</span></td>
            <td>${u.active ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="crmForms.user('${u.id}')">
                  <i class="bi bi-pencil-square"></i>
                </button>
                ${state.currentUser.role === 'admin' ? `
                  <button class="btn btn-outline-danger" onclick="handlers.deleteUser('${u.id}')">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `).join('');
        
        // Render pending users
        const pendingTbody = document.getElementById('pendingUsersTbody');
        if (pendingTbody) {
          pendingTbody.innerHTML = state.pendingUsers.map(u => `
            <tr>
              <td>${u.email}</td>
              <td>${new Date(u.created_at).toLocaleDateString('vi-VN')}</td>
              <td>
                <button class="btn btn-success btn-sm" onclick="handlers.approveUser('${u.id}')">
                  <i class="bi bi-check-circle me-1"></i>Approve
                </button>
                ${state.currentUser.role === 'admin' ? `
                  <button class="btn btn-danger btn-sm ms-1" onclick="handlers.rejectUser('${u.id}')">
                    <i class="bi bi-x-circle"></i>
                  </button>
                ` : ''}
              </td>
            </tr>
          `).join('') || '<tr><td colspan="3" class="text-center text-muted">Không có user đang chờ</td></tr>';
        }
      }
    };

    /* ===== FORM BUILDERS ===== */
    const crmForms = {
      customer(id = '') {
        const wrap = document.getElementById('customerFormWrap');
        const isEdit = !!id;
        
        // Check permission for edit
        if (isEdit && !storage.canEdit('customers', id)) {
          utils.showToast('Bạn không có quyền sửa khách hàng này', 'error');
          return;
        }
        
        const c = isEdit ? state.customers.find(x => x.id === id) : {};
        
        wrap.classList.remove('d-none');
        wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${isEdit ? 'Sửa' : 'Thêm'} khách hàng</h5>
              <form id="customerForm">
                <div class="row g-3">
                  <div class="col-md-2">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="cust_id" value="${isEdit ? c.id : generators.customerId()}">
                  </div>
                  <div class="col-md-10 position-relative">
                    <label class="form-label">Tên khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="cust_name" value="${c?.name || ''}" autocomplete="off" required>
                    <div id="cust_name_sugs" class="suggestions d-none"></div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Người liên hệ</label>
                    <input class="form-control" id="cust_contact" value="${c?.contact_person || ''}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Phone</label>
                    <input class="form-control" id="cust_phone" value="${c?.phone || ''}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="cust_email" value="${c?.email || ''}">
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Địa chỉ</label>
                    <input class="form-control" id="cust_address" value="${c?.address || ''}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Mã số thuế</label>
                    <input class="form-control" id="cust_tax" value="${c?.tax_code || ''}">
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Lưu
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('customerFormWrap').classList.add('d-none')">
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        // Attach events
        document.getElementById('customerForm').onsubmit = (e) => {
          e.preventDefault();
          handlers.saveCustomer(id);
        };
        
        const nameInput = document.getElementById('cust_name');
        nameInput.oninput = utils.debounce(() => autocomplete.suggestExistingCustomer(nameInput.value), CONFIG.DEBOUNCE_DELAY);
      },
      
      project(id = '') {
        const wrap = document.getElementById('projectFormWrap');
        const isEdit = !!id;
        
        // Check permission for edit
        if (isEdit && !storage.canEdit('projects', id)) {
          utils.showToast('Bạn không có quyền sửa dự án này', 'error');
          return;
        }
        
        const p = isEdit ? state.projects.find(x => x.project_id === id) : {};
        const customer = state.cache.customerMap.get(p?.customer_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${isEdit ? 'Sửa' : 'Thêm'} dự án</h5>
              <form id="projectForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">Start</label>
                    <input type="date" class="form-control" id="pr_start" value="${p?.start_date || ''}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">End</label>
                    <input type="date" class="form-control" id="pr_end" value="${p?.end_date || ''}">
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="pr_status">
                      <option ${p?.status === 'Chuẩn bị' ? 'selected' : ''}>Chuẩn bị</option>
                      <option ${p?.status === 'Đang triển khai' ? 'selected' : ''}>Đang triển khai</option>
                      <option ${p?.status === 'Hoàn thành' ? 'selected' : ''}>Hoàn thành</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-control" rows="2" id="pr_desc">${p?.description || ''}</textarea>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Lưu
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('projectFormWrap').classList.add('d-none')">
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.getElementById('projectForm').onsubmit = (e) => {
          e.preventDefault();
          handlers.saveProject(id);
        };
        
        const clientInput = document.getElementById('pr_client');
        clientInput.oninput = utils.debounce(() => autocomplete.suggestCustomer(clientInput.value, 'pr_client'), CONFIG.DEBOUNCE_DELAY);
      },
      
      opportunity(id = '') {
        const wrap = document.getElementById('oppFormWrap');
        const isEdit = !!id;
        
        // Check permission for edit
        if (isEdit && !storage.canEdit('opportunities', id)) {
          utils.showToast('Bạn không có quyền sửa cơ hội này', 'error');
          return;
        }
        
        const o = isEdit ? state.opportunities.find(x => x.opportunity_id === id) : {};
        const customer = state.cache.customerMap.get(o?.customer_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${isEdit ? 'Sửa' : 'Thêm'} cơ hội</h5>
              <form id="oppForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="op_id" value="${isEdit ? o.opportunity_id : generators.opportunityId()}">
                  </div>
                  <div class="col-md-9">
                    <label class="form-label">Tên cơ hội <span class="text-danger">*</span></label>
                    <input class="form-control" id="op_name" value="${o?.name || ''}" required>
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="op_client" autocomplete="off" value="${customer?.name || ''}" required>
                    <div id="op_client_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="op_client_id" value="${o?.customer_id || ''}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Giá trị kỳ vọng</label>
                    <input type="number" class="form-control" id="op_val" value="${o?.expected_value || 0}">
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Stage</label>
                    <select class="form-select" id="op_stage">
                      <option ${o?.stage === 'mới' ? 'selected' : ''}>mới</option>
                      <option ${o?.stage === 'đánh giá' ? 'selected' : ''}>đánh giá</option>
                      <option ${o?.stage === 'đàm phán' ? 'selected' : ''}>đàm phán</option>
                      <option ${o?.stage === 'đã thắng' ? 'selected' : ''}>đã thắng</option>
                      <option ${o?.stage === 'đã mất' ? 'selected' : ''}>đã mất</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Lưu
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('oppFormWrap').classList.add('d-none')">
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.getElementById('oppForm').onsubmit = (e) => {
          e.preventDefault();
          handlers.saveOpportunity(id);
        };
        
        const clientInput = document.getElementById('op_client');
        clientInput.oninput = utils.debounce(() => autocomplete.suggestCustomer(clientInput.value, 'op_client'), CONFIG.DEBOUNCE_DELAY);
      },
      
      quote(id = '') {
        const wrap = document.getElementById('quoteFormWrap');
        const isEdit = !!id;
        
        // Check permission for edit
        if (isEdit && !storage.canEdit('quotes', id)) {
          utils.showToast('Bạn không có quyền sửa báo giá này', 'error');
          return;
        }
        
        const q = isEdit ? state.quotes.find(x => x.quotes_id === id) : {};
        const customer = state.cache.customerMap.get(q?.customer_id);
        const project = state.cache.projectMap.get(q?.project_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${isEdit ? 'Sửa' : 'Thêm'} báo giá</h5>
              <form id="quoteForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="q_id" value="${isEdit ? q.quotes_id : generators.quoteId()}">
                  </div>
                  <div class="col-md-9 position-relative">
                    <label class="form-label">Khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="q_client" autocomplete="off" value="${customer?.name || ''}" required>
                    <div id="q_client_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="q_client_id" value="${q?.customer_id || ''}">
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Dự án</label>
                    <input class="form-control" id="q_project" autocomplete="off" value="${project?.project_name || ''}">
                    <div id="q_project_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="q_project_id" value="${q?.project_id || ''}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Số tiền</label>
                    <input type="number" class="form-control" id="q_amount" value="${q?.amount || 0}">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Nội dung</label>
                    <textarea class="form-control" rows="2" id="q_desc">${q?.description || ''}</textarea>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="q_status">
                      <option ${q?.status === 'nháp' ? 'selected' : ''}>nháp</option>
                      <option ${q?.status === 'đã gửi' ? 'selected' : ''}>đã gửi</option>
                      <option ${q?.status === 'chấp nhận' ? 'selected' : ''}>chấp nhận</option>
                      <option ${q?.status === 'từ chối' ? 'selected' : ''}>từ chối</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Lần gửi</label>
                    <input type="number" class="form-control" id="q_send" value="${q?.send_count || 0}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">PDF URL</label>
                    <input class="form-control" id="q_pdf" placeholder="https://...pdf" value="${q?.pdf_url || ''}">
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Lưu báo giá
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('quoteFormWrap').classList.add('d-none')">
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.getElementById('quoteForm').onsubmit = (e) => {
          e.preventDefault();
          handlers.saveQuote(id);
        };
        
        const clientInput = document.getElementById('q_client');
        clientInput.oninput = utils.debounce(() => autocomplete.suggestCustomer(clientInput.value, 'q_client'), CONFIG.DEBOUNCE_DELAY);
        
        const projectInput = document.getElementById('q_project');
        projectInput.oninput = utils.debounce(() => autocomplete.suggestProject(projectInput.value, 'q_project'), CONFIG.DEBOUNCE_DELAY);
      },
      
      contract(id = '') {
        const wrap = document.getElementById('contractFormWrap');
        const isEdit = !!id;
        
        // Check permission for edit
        if (isEdit && !storage.canEdit('contracts', id)) {
          utils.showToast('Bạn không có quyền sửa hợp đồng này', 'error');
          return;
        }
        
        const ct = isEdit ? state.contracts.find(x => x.contract_id === id) : {};
        const project = state.cache.projectMap.get(ct?.project_id);
        
        wrap.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${isEdit ? 'Sửa' : 'Thêm'} hợp đồng</h5>
              <form id="contractForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">ID</label>
                    <input class="form-control" disabled id="ct_id" value="${isEdit ? ct.contract_id : generators.contractId()}">
                  </div>
                  <div class="col-md-9 position-relative">
                    <label class="form-label">Dự án <span class="text-danger">*</span></label>
                    <input class="form-control" id="ct_proj" autocomplete="off" value="${project?.project_name || ''}" required>
                    <div id="ct_proj_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="ct_proj_id" value="${ct?.project_id || ''}">
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Báo giá (tùy chọn)</label>
                    <input class="form-control" id="ct_quote" autocomplete="off" value="${ct?.quotes_id || ''}">
                    <div id="ct_quote_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="ct_quote_id" value="${ct?.quotes_id || ''}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Giá trị</label>
                    <input type="number" class="form-control" id="ct_val" value="${ct?.value || 0}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Ngày HĐ</label>
                    <input type="date" class="form-control" id="ct_date" value="${ct?.contract_date || ''}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" id="ct_status">
                      <option ${ct?.status === 'hiệu lực' ? 'selected' : ''}>hiệu lực</option>
                      <option ${ct?.status === 'hoàn thành' ? 'selected' : ''}>hoàn thành</option>
                      <option ${ct?.status === 'hủy' ? 'selected' : ''}>hủy</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Lưu
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('contractFormWrap').classList.add('d-none')">
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.getElementById('contractForm').onsubmit = (e) => {
          e.preventDefault();
          handlers.saveContract(id);
        };
        
        const projInput = document.getElementById('ct_proj');
        projInput.oninput = utils.debounce(() => autocomplete.suggestProject(projInput.value, 'ct_proj'), CONFIG.DEBOUNCE_DELAY);
        
        const quoteInput = document.getElementById('ct_quote');
        quoteInput.oninput = utils.debounce(() => autocomplete.suggestQuote(quoteInput.value, 'ct_quote'), CONFIG.DEBOUNCE_DELAY);
      },
      
      user(id = '') {
        const wrap = document.getElementById('userFormWrap');
        const isEdit = !!id;
        const u = isEdit ? [...state.users, ...state.pendingUsers].find(x => x.id === id) : {};
        
        wrap.classList.remove('d-none');
        wrap.innerHTML = `
          <div class="card card-shadow mb-4 fade-in">
            <div class="card-body">
              <h5 class="card-title mb-3">${isEdit ? 'Sửa' : 'Thêm'} user</h5>
              <form id="userForm">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="us_email" value="${u?.email || ''}" ${isEdit ? 'disabled' : 'required'}>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="us_role">
                      <option value="user" ${u?.role === 'user' ? 'selected' : ''}>user</option>
                      <option value="admin" ${u?.role === 'admin' ? 'selected' : ''}>admin</option>
                      <option value="BOM" ${u?.role === 'BOM' ? 'selected' : ''}>BOM</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Active</label>
                    <select class="form-select" id="us_active">
                      <option value="true" ${u?.active ? 'selected' : ''}>true</option>
                      <option value="false" ${!u?.active ? 'selected' : ''}>false</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Lưu
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('userFormWrap').classList.add('d-none')">
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        document.getElementById('userForm').onsubmit = (e) => {
          e.preventDefault();
          handlers.saveUser(id);
        };
      }
    };

    /* ===== CRUD HANDLERS ===== */
    const handlers = {
      async saveCustomer(id) {
        // Check permission for edit
        if (id && !storage.canEdit('customers', id)) {
          utils.showToast('Bạn không có quyền sửa khách hàng này', 'error');
          return;
        }
        
        const payload = {
          name: document.getElementById('cust_name').value.trim(),
          contact_person: document.getElementById('cust_contact').value || null,
          phone: document.getElementById('cust_phone').value || null,
          email: document.getElementById('cust_email').value || null,
          address: document.getElementById('cust_address').value || null,
          tax_code: document.getElementById('cust_tax').value || null
        };
        
        if (!payload.name) {
          utils.showToast('Tên khách hàng không được trống', 'error');
          return;
        }
        
        const btn = document.querySelector('#customerForm button[type="submit"]');
        const stopLoading = utils.showLoading(btn);
        
        let success;
        if (id) {
          success = await crud.update('customers', payload, 'id', id);
        } else {
          payload.id = document.getElementById('cust_id').value;
          payload.created_at = new Date().toISOString();
          success = await crud.create('customers', payload);
          if (success) {
            storage.pushMyCustomerId(payload.id);
            storage.setCreatedBy('customers', payload.id, state.currentUser.id); // Store user.id
          }
        }
        
        stopLoading();
        
        if (success) {
          renderers.customers();
          renderers.dashboard();
          document.getElementById('customerFormWrap').classList.add('d-none');
        }
      },
      
      async saveProject(id) {
        // Check permission for edit
        if (id && !storage.canEdit('projects', id)) {
          utils.showToast('Bạn không có quyền sửa dự án này', 'error');
          return;
        }
        
        const payload = {
          project_name: document.getElementById('pr_name').value.trim(),
          customer_id: document.getElementById('pr_client_id').value,
          description: document.getElementById('pr_desc').value || null,
          start_date: document.getElementById('pr_start').value || null,
          end_date: document.getElementById('pr_end').value || null,
          status: document.getElementById('pr_status').value
        };
        
        if (!payload.project_name) {
          utils.showToast('Tên dự án không được trống', 'error');
          return;
        }
        
        if (!payload.customer_id) {
          utils.showToast('Chưa chọn khách hàng hợp lệ', 'error');
          return;
        }
        
        const btn = document.querySelector('#projectForm button[type="submit"]');
        const stopLoading = utils.showLoading(btn);
        
        let success;
        if (id) {
          success = await crud.update('projects', payload, 'project_id', id);
        } else {
          payload.project_id = document.getElementById('pr_id').value;
          payload.created_at = new Date().toISOString();
          success = await crud.create('projects', payload);
          if (success) {
            storage.setCreatedBy('projects', payload.project_id, state.currentUser.id); // Store user.id
          }
        }
        
        stopLoading();
        
        if (success) {
          renderers.projects();
          renderers.dashboard();
          document.getElementById('projectFormWrap').classList.add('d-none');
        }
      },
      
      async saveOpportunity(id) {
        // Check permission for edit
        if (id && !storage.canEdit('opportunities', id)) {
          utils.showToast('Bạn không có quyền sửa cơ hội này', 'error');
          return;
        }
        
        const payload = {
          name: document.getElementById('op_name').value.trim(),
          customer_id: document.getElementById('op_client_id').value,
          expected_value: parseInt(document.getElementById('op_val').value || '0', 10),
          stage: document.getElementById('op_stage').value
        };
        
        if (!payload.name) {
          utils.showToast('Tên cơ hội không được trống', 'error');
          return;
        }
        
        if (!payload.customer_id) {
          utils.showToast('Chưa chọn khách hàng hợp lệ', 'error');
          return;
        }
        
        const btn = document.querySelector('#oppForm button[type="submit"]');
        const stopLoading = utils.showLoading(btn);
        
        let success;
        if (id) {
          success = await crud.update('opportunities', payload, 'opportunity_id', id);
        } else {
          payload.opportunity_id = document.getElementById('op_id').value;
          payload.created_at = new Date().toISOString();
          success = await crud.create('opportunities', payload);
          if (success) {
            storage.setCreatedBy('opportunities', payload.opportunity_id, state.currentUser.id); // Store user.id
          }
        }
        
        stopLoading();
        
        if (success) {
          renderers.opportunities();
          renderers.dashboard();
          document.getElementById('oppFormWrap').classList.add('d-none');
        }
      },
      
      async saveQuote(id) {
        // Check permission for edit
        if (id && !storage.canEdit('quotes', id)) {
          utils.showToast('Bạn không có quyền sửa báo giá này', 'error');
          return;
        }
        
        const payload = {
          customer_id: document.getElementById('q_client_id').value,
          project_id: document.getElementById('q_project_id').value || null,
          description: document.getElementById('q_desc').value || null,
          amount: parseInt(document.getElementById('q_amount').value || '0', 10),
          status: document.getElementById('q_status').value,
          send_count: parseInt(document.getElementById('q_send').value || '0', 10),
          pdf_url: document.getElementById('q_pdf').value || null
        };
        
        if (!payload.customer_id) {
          utils.showToast('Chưa chọn khách hàng hợp lệ', 'error');
          return;
        }
        
        const btn = document.querySelector('#quoteForm button[type="submit"]');
        const stopLoading = utils.showLoading(btn);
        
        let success;
        if (id) {
          success = await crud.update('quotes', payload, 'quotes_id', id);
        } else {
          payload.quotes_id = document.getElementById('q_id').value;
          payload.created_at = new Date().toISOString();
          success = await crud.create('quotes', payload);
          if (success) {
            storage.setCreatedBy('quotes', payload.quotes_id, state.currentUser.id); // Store user.id
          }
        }
        
        stopLoading();
        
        if (success) {
          renderers.quotes();
          document.getElementById('quoteFormWrap').classList.add('d-none');
        }
      },
      
      async saveContract(id) {
        // Check permission for edit
        if (id && !storage.canEdit('contracts', id)) {
          utils.showToast('Bạn không có quyền sửa hợp đồng này', 'error');
          return;
        }
        
        const projId = document.getElementById('ct_proj_id').value;
        const project = state.cache.projectMap.get(projId);
        
        const payload = {
          project_id: projId,
          customer_id: project?.customer_id,
          quotes_id: document.getElementById('ct_quote_id').value || null,
          value: parseInt(document.getElementById('ct_val').value || '0', 10),
          contract_date: document.getElementById('ct_date').value || null,
          status: document.getElementById('ct_status').value
        };
        
        if (!payload.project_id) {
          utils.showToast('Chưa chọn dự án hợp lệ', 'error');
          return;
        }
        
        const btn = document.querySelector('#contractForm button[type="submit"]');
        const stopLoading = utils.showLoading(btn);
        
        let success;
        if (id) {
          success = await crud.update('contracts', payload, 'contract_id', id);
        } else {
          payload.contract_id = document.getElementById('ct_id').value;
          payload.created_at = new Date().toISOString();
          success = await crud.create('contracts', payload);
          if (success) {
            storage.setCreatedBy('contracts', payload.contract_id, state.currentUser.id); // Store user.id
          }
        }
        
        stopLoading();
        
        if (success) {
          renderers.contracts();
          document.getElementById('contractFormWrap').classList.add('d-none');
        }
      },
      
      async saveUser(id) {
        const payload = {
          role: document.getElementById('us_role').value,
          active: document.getElementById('us_active').value === 'true'
        };
        
        if (!id) {
          // For new users, we can't directly create in user_profiles
          // They need to login first via Google OAuth
          utils.showToast('User mới cần đăng nhập qua Google trước, sau đó admin approve', 'error');
          return;
        }
        
        const btn = document.querySelector('#userForm button[type="submit"]');
        const stopLoading = utils.showLoading(btn);
        
        const success = await crud.update('user_profiles', payload, 'id', id);
        
        stopLoading();
        
        if (success) {
          renderers.users();
          document.getElementById('userFormWrap').classList.add('d-none');
        }
      },
      
      async approveUser(userId) {
        if (!confirm('Approve user này?')) return;
        
        const success = await crud.update('user_profiles', {
          active: true,
          role: 'user'
        }, 'id', userId);
        
        if (success) {
          renderers.users();
        }
      },
      
      async rejectUser(userId) {
        if (!confirm('Từ chối và xóa user này?')) return;
        
        if (await crud.delete('user_profiles', 'id', userId)) {
          renderers.users();
        }
      },
      
      async deleteCustomer(id) {
        if (!storage.canEdit('customers', id)) {
          utils.showToast('Bạn không có quyền xóa khách hàng này', 'error');
          return;
        }
        if (!confirm('Xóa khách hàng này?')) return;
        if (await crud.delete('customers', 'id', id)) {
          renderers.customers();
          renderers.dashboard();
        }
      },
      
      async deleteProject(id) {
        if (!storage.canEdit('projects', id)) {
          utils.showToast('Bạn không có quyền xóa dự án này', 'error');
          return;
        }
        if (!confirm('Xóa dự án này?')) return;
        if (await crud.delete('projects', 'project_id', id)) {
          renderers.projects();
          renderers.dashboard();
        }
      },
      
      async deleteOpportunity(id) {
        if (!storage.canEdit('opportunities', id)) {
          utils.showToast('Bạn không có quyền xóa cơ hội này', 'error');
          return;
        }
        if (!confirm('Xóa cơ hội này?')) return;
        if (await crud.delete('opportunities', 'opportunity_id', id)) {
          renderers.opportunities();
          renderers.dashboard();
        }
      },
      
      async deleteQuote(id) {
        if (!storage.canEdit('quotes', id)) {
          utils.showToast('Bạn không có quyền xóa báo giá này', 'error');
          return;
        }
        if (!confirm('Xóa báo giá này?')) return;
        if (await crud.delete('quotes', 'quotes_id', id)) {
          renderers.quotes();
        }
      },
      
      async deleteContract(id) {
        if (!storage.canEdit('contracts', id)) {
          utils.showToast('Bạn không có quyền xóa hợp đồng này', 'error');
          return;
        }
        if (!confirm('Xóa hợp đồng này?')) return;
        if (await crud.delete('contracts', 'contract_id', id)) {
          renderers.contracts();
        }
      },
      
      async deleteUser(id) {
        if (!confirm('Xóa user này?')) return;
        if (await crud.delete('user_profiles', 'id', id)) {
          renderers.users();
        }
      }
    };

    /* ===== AUTOCOMPLETE ===== */
    const autocomplete = {
      activeIndex: -1,
      
      navigate(box, direction) {
        const items = box.querySelectorAll('.suggestion-item');
        if (!items.length) return;
        
        items[this.activeIndex]?.classList.remove('active');
        
        if (direction === 'down') {
          this.activeIndex = (this.activeIndex + 1) % items.length;
        } else {
          this.activeIndex = (this.activeIndex - 1 + items.length) % items.length;
        }
        
        items[this.activeIndex]?.classList.add('active');
        items[this.activeIndex]?.scrollIntoView({ block: 'nearest' });
      },
      
      select(box) {
        const active = box.querySelector('.suggestion-item.active');
        if (active) active.click();
      },
      
      suggestExistingCustomer(q) {
        const box = document.getElementById('cust_name_sugs');
        box.innerHTML = '';
        this.activeIndex = -1;
        
        if (!q) {
          box.classList.add('d-none');
          return;
        }
        
        const list = state.customers.filter(c =>
          (c.name || '').toLowerCase().includes(q.toLowerCase()) ||
          (c.id || '').toLowerCase().includes(q.toLowerCase())
        );
        
        if (list.length) {
          list.forEach(c => {
            const d = document.createElement('div');
            d.className = 'suggestion-item';
            d.textContent = `${c.id} – ${c.name}`;
            d.onclick = () => {
              document.getElementById('cust_id').value = c.id;
              document.getElementById('cust_name').value = c.name;
              document.getElementById('cust_contact').value = c.contact_person || '';
              document.getElementById('cust_phone').value = c.phone || '';
              document.getElementById('cust_email').value = c.email || '';
              document.getElementById('cust_address').value = c.address || '';
              document.getElementById('cust_tax').value = c.tax_code || '';
              box.classList.add('d-none');
            };
            box.appendChild(d);
          });
        } else {
          const d = document.createElement('div');
          d.className = 'suggestion-item text-primary';
          d.textContent = '+ Tạo khách hàng mới';
          d.onclick = () => {
            const newId = generators.customerId();
            document.getElementById('cust_id').value = newId;
            document.getElementById('cust_name').value = q;
            document.getElementById('cust_contact').value = '';
            document.getElementById('cust_phone').value = '';
            document.getElementById('cust_email').value = '';
            document.getElementById('cust_address').value = '';
            document.getElementById('cust_tax').value = '';
            box.classList.add('d-none');
          };
          box.appendChild(d);
        }
        
        box.classList.remove('d-none');
      },
      
      suggestCustomer(q, fld) {
        const box = document.getElementById(`${fld}_sugs`);
        box.innerHTML = '';
        this.activeIndex = -1;
        
        if (!q) {
          box.classList.add('d-none');
          return;
        }
        
        const list = state.customers.filter(c =>
          (c.name || '').toLowerCase().includes(q.toLowerCase()) ||
          (c.id || '').toLowerCase().includes(q.toLowerCase())
        );
        
        list.forEach(c => {
          const d = document.createElement('div');
          d.className = 'suggestion-item';
          d.textContent = `${c.id} – ${c.name}`;
          d.onclick = () => {
            document.getElementById(fld).value = c.name;
            const hid = document.getElementById(`${fld}_id`);
            if (hid) hid.value = c.id;
            box.classList.add('d-none');
          };
          box.appendChild(d);
        });
        
        box.classList.remove('d-none');
      },
      
      suggestProject(q, fld) {
        const box = document.getElementById(`${fld}_sugs`);
        box.innerHTML = '';
        this.activeIndex = -1;
        
        const custId = document.getElementById(fld === 'q_project' ? 'q_client_id' : 'ct_client_id')?.value;
        
        if (fld === 'q_project' && !custId) {
          box.innerHTML = `<div class="suggestion-item text-danger">Vui lòng chọn Khách hàng trước</div>`;
          return box.classList.remove('d-none');
        }
        
        let list = state.projects.filter(p =>
          (p.project_name || '').toLowerCase().includes(q.toLowerCase()) ||
          (p.project_id || '').toLowerCase().includes(q.toLowerCase())
        );
        
        if (fld === 'q_project' && custId) {
          list = list.filter(p => p.customer_id === custId);
        }
        
        if (list.length) {
          list.forEach(p => {
            const d = document.createElement('div');
            d.className = 'suggestion-item';
            d.textContent = `${p.project_id} – ${p.project_name}`;
            d.onclick = () => {
              document.getElementById(fld).value = p.project_name;
              document.getElementById(`${fld}_id`).value = p.project_id;
              box.classList.add('d-none');
            };
            box.appendChild(d);
          });
        } else if (fld === 'q_project') {
          const d = document.createElement('div');
          d.className = 'suggestion-item text-primary';
          d.textContent = '+ Thêm dự án mới';
          d.onclick = () => {
            box.classList.add('d-none');
            ui.showSection('projects');
            crmForms.project();
            setTimeout(() => {
              document.getElementById('pr_client_id').value = custId;
              document.getElementById('pr_client').value = document.getElementById('q_client').value;
            }, 0);
          };
          box.appendChild(d);
        }
        
        box.classList.remove('d-none');
      },
      
      suggestQuote(q, fld) {
        const box = document.getElementById(`${fld}_sugs`);
        box.innerHTML = '';
        this.activeIndex = -1;
        
        if (!q) {
          box.classList.add('d-none');
          return;
        }
        
        const list = state.quotes.filter(x =>
          (x.quotes_id || '').toLowerCase().includes(q.toLowerCase())
        );
        
        list.forEach(x => {
          const d = document.createElement('div');
          d.className = 'suggestion-item';
          d.textContent = x.quotes_id;
          d.onclick = () => {
            document.getElementById(fld).value = x.quotes_id;
            const hid = document.getElementById(`${fld}_id`);
            if (hid) hid.value = x.quotes_id;
            box.classList.add('d-none');
          };
          box.appendChild(d);
        });
        
        box.classList.remove('d-none');
      }
    };

    /* ===== AUTH FUNCTIONS ===== */
    const auth = {
      showOverlay(msg = '') {
        const el = document.getElementById('authOverlay');
        if (msg) document.getElementById('authError').textContent = msg;
        el.classList.remove('d-none');
      },
      
      hideOverlay() {
        document.getElementById('authError').textContent = '';
        document.getElementById('authOverlay').classList.add('d-none');
      },
      
      showPendingOverlay(email) {
        document.getElementById('pendingEmail').textContent = email;
        document.getElementById('pendingOverlay').classList.remove('d-none');
      },
      
      hidePendingOverlay() {
        document.getElementById('pendingOverlay').classList.add('d-none');
      },
      
      applyRoleUI() {
        const isElevated = ['admin', 'BOM'].includes(state.currentUser.role);
        
        // Hide services (always)
        document.getElementById('navServices').style.display = 'none';
        
        // Hide based on role
        const hideForUser = ['projects', 'opportunities'];
        hideForUser.forEach(pg => {
          const link = document.querySelector(`#sidebarNav .nav-link[data-page="${pg}"]`);
          if (link) link.parentElement.style.display = isElevated ? '' : 'none';
        });
      },
      
      async checkAuth() {
        try {
          const { data: { session } } = await sb.auth.getSession();
          
          if (!session) {
            auth.showOverlay();
            return;
          }
          
          // User đã login, lấy profile dựa trên user.id
          const { data: profile, error } = await sb.from('user_profiles')
            .select('*')
            .eq('id', session.user.id)
            .single();
          
          if (error || !profile) {
            // Profile chưa tồn tại (trigger sẽ tự tạo)
            // Retry sau 1s để trigger kịp chạy
            setTimeout(() => auth.checkAuth(), 1000);
            return;
          }
          
          if (!profile.active) {
            // User exists nhưng chưa được approve
            auth.showPendingOverlay(profile.email);
            return;
          }
          
          // User active, lưu thông tin
          state.currentUser = {
            id: session.user.id,  // QUAN TRỌNG: lưu user.id
            email: profile.email,
            role: profile.role || 'user',
            active: profile.active
          };
          
          document.getElementById('currentEmail').textContent = state.currentUser.email;
          auth.hideOverlay();
          auth.hidePendingOverlay();
          
          await loadData();
          auth.applyRoleUI();
          renderAll();
          ui.showSection('dashboard');
          
        } catch (e) {
          console.error('Auth error:', e);
          auth.showOverlay('Không thể xác thực. Vui lòng thử lại.');
        }
      }
    };

    /* ===== RENDER ALL ===== */
    function renderAll() {
      renderers.dashboard();
      renderers.customers();
      renderers.projects();
      renderers.opportunities();
      renderers.quotes();
      renderers.contracts();
      renderers.users();
    }

    /* ===== EVENT LISTENERS ===== */
    document.addEventListener('DOMContentLoaded', () => {
      // Sidebar toggle
      document.getElementById('sidebarToggle').addEventListener('click', () => ui.toggleSidebar());
      document.getElementById('sidebarBackdrop').addEventListener('click', () => ui.toggleSidebar(false));
      
      // Navigation
      document.querySelectorAll('#sidebarNav .nav-link[data-page]').forEach(a => {
        a.addEventListener('click', () => ui.showSection(a.dataset.page));
      });
      
      // Add buttons
      document.getElementById('btnAddCustomer').onclick = () => crmForms.customer();
      document.getElementById('btnAddProject').onclick = () => crmForms.project();
      document.getElementById('btnAddOpportunity').onclick = () => crmForms.opportunity();
      document.getElementById('btnAddQuote').onclick = () => crmForms.quote();
      document.getElementById('btnAddContract').onclick = () => crmForms.contract();
      document.getElementById('btnAddUser').onclick = () => {
        utils.showToast('User mới cần đăng nhập qua Google trước', 'info');
      };
      
      // Pending users toggle
      document.getElementById('btnPendingUsers').onclick = () => {
        const wrap = document.getElementById('pendingUsersWrap');
        wrap.classList.toggle('d-none');
      };
      
      // Auth buttons
      document.getElementById('btnGoogle').addEventListener('click', () => {
        sb.auth.signInWithOAuth({
          provider: 'google',
          options: { 
            redirectTo: window.location.href,
            queryParams: {
              access_type: 'offline',
              prompt: 'consent'
            }
          }
        });
      });
      
      document.getElementById('btnCheckAgain').onclick = () => auth.checkAuth();
      
      document.getElementById('btnSignOut').onclick = async (e) => {
        e.preventDefault();
        await sb.auth.signOut();
        location.reload();
      };
      
      document.getElementById('btnSignOutPending').onclick = async (e) => {
        e.preventDefault();
        await sb.auth.signOut();
        location.reload();
      };
      
      // Global click handler for closing suggestions
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.suggestions') && !e.target.closest('input')) {
          document.querySelectorAll('.suggestions').forEach(b => b.classList.add('d-none'));
        }
      });
      
      // Keyboard navigation for autocomplete
      document.addEventListener('keydown', (e) => {
        const activeInput = document.activeElement;
        if (activeInput.tagName === 'INPUT') {
          const sugsId = activeInput.id + '_sugs';
          const box = document.getElementById(sugsId);
          
          if (box && !box.classList.contains('d-none')) {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              autocomplete.navigate(box, 'down');
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              autocomplete.navigate(box, 'up');
            } else if (e.key === 'Enter') {
              e.preventDefault();
              autocomplete.select(box);
            } else if (e.key === 'Escape') {
              box.classList.add('d-none');
            }
          }
        }
      });
      
      // Auth state change listener
      sb.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
          auth.checkAuth();
        } else if (event === 'SIGNED_OUT') {
          auth.showOverlay();
        }
      });
      
      // Initialize auth check
      auth.checkAuth();
    });

    /* ===== GLOBAL FUNCTION EXPORTS ===== */
    // Export functions to global scope for onclick handlers
    window.crmForms = crmForms;
    window.handlers = handlers;
    window.autocomplete = autocomplete;
  </script>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>ID</label>
                    <input class="form-control" disabled id="pr_id" value="${isEdit ? p.project_id : generators.projectId()}">
                  </div>
                  <div class="col-md-9">
                    <label class="form-label">Tên dự án <span class="text-danger">*</span></label>
                    <input class="form-control" id="pr_name" value="${p?.project_name || ''}" required>
                  </div>
                  <div class="col-md-6 position-relative">
                    <label class="form-label">Khách hàng <span class="text-danger">*</span></label>
                    <input class="form-control" id="pr_client" autocomplete="off" value="${customer?.name || ''}" required>
                    <div id="pr_client_sugs" class="suggestions d-none"></div>
                    <input type="hidden" id="pr_client_id" value="${p?.customer_id || ''}">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">
